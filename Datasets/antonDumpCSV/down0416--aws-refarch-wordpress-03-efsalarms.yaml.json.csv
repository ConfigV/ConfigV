Resources.AWS::IAM::InstanceProfile.Properties.Path,/
Mappings.RegionMap.eu-central-1.AMI,ami-c7ee5ca8
Parameters.EC2KeyName.Type,AWS::EC2::KeyPair::KeyName
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.Tags,"[{u'Value': [u'', [u'Updating ', u'ElasticFileSystem', u' burst credit balance Cloudwatch alarms.. will auto terminate']], u'PropagateAtLaunch': True, u'Key': u'Name'}]"
Parameters.Subnet.Description,Select existing subnets.
Metadata.AWS::CloudFormation::Interface.ParameterLabels.EmailAddress.default,SNS Email Address
Metadata.License.Description,"Copyright 2018 Amazon.com, Inc. and its affiliates. All Rights Reserved. Licensed under the Amazon Software License (the ""License""). You may not use this file except in compliance with the License. A copy of the License is located at http://aws.amazon.com/asl/ or in the ""license"" file accompanying this file. This file is distributed on an ""AS IS"" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License."
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.MinSize,0
Metadata.AWS::CloudFormation::Interface.ParameterLabels.NumberOfSubnets.default,Number of subnets
Parameters.EmailAddress.Type,String
Metadata.AWS::CloudFormation::Interface.ParameterLabels.Subnet.default,Subnets
Parameters.WarningThreshold.Type,String
Parameters.ElasticFileSystem.Type,String
Outputs.BurstCreditBalanceDecreaseAlarmArn.Value,BurstCreditBalanceDecreaseAlarm.Arn
Metadata.AWS::CloudFormation::Interface.ParameterLabels.WarningThreshold.default,Burst Credit Balance Warning Threshold (Minutes)
Parameters.CriticalThreshold.Default,60
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.HealthCheckType,EC2
Resources.AWS::CloudWatch::Alarm.Properties.AlarmName,"[u'', [u'Set ', u'ElasticFileSystem', u' burst credit balance increase threshold - ', u'AWS::StackName']]"
Resources.AWS::AutoScaling::LaunchConfiguration.Properties.SecurityGroups,[u'SecurityGroup']
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.DesiredCapacity,1
Resources.AWS::IAM::Role.Properties.AssumeRolePolicyDocument.Version,2012-10-17
Resources.AWS::AutoScaling::LaunchConfiguration.DependsOn,WarningAlarm
Parameters.WarningThreshold.Description,Send warning alarm this many minutes before burst credit balance is zero.
Resources.AWS::CloudWatch::Alarm.Properties.TreatMissingData,missing
Metadata.AWS::CloudFormation::Interface.ParameterGroups,"[{u'Parameters': [u'ElasticFileSystem', u'WarningThreshold', u'CriticalThreshold', u'EmailAddress', u'InstanceType', u'EC2KeyName', u'SecurityGroup', u'NumberOfSubnets', u'Subnet'], u'Label': {u'default': u'Amazon EFS Parameters'}}]"
Resources.AWS::AutoScaling::LaunchConfiguration.Properties.UserData,{u'Fn::Base64': u'#cloud-config\nrepo_update: true\nrepo_upgrade: all\n\npackages:\n\nruncmd:\n- ntpstat\n- /opt/aws/bin/cfn-init --configsets set_cloudwatch_alarms --verbose --stack ${AWS::StackName} --resource LaunchConfiguration --region ${AWS::Region}\n- /tmp/set-cloudwatch-alarms.sh ${ElasticFileSystem} ${WarningThreshold} ${CriticalThreshold} ${SNSTopic}\n'}
Resources.AWS::SNS::Topic.Properties.TopicName,"[u'', [u'ElasticFileSystem', u'-alarm-notification']]"
Resources.AWS::CloudWatch::Alarm.Properties.AlarmDescription,"[u'', [u'Set ', u'ElasticFileSystem', u' burst credit balance increase threshold - ', u'AWS::StackName']]"
Resources.AWS::CloudWatch::Alarm.Properties.ComparisonOperator,LessThanThreshold
Resources.AWS::AutoScaling::LaunchConfiguration.Metadata.AWS::CloudFormation::Init.set-cloudwatch-alarms.files./tmp/set-cloudwatch-alarms.sh.owner,root
Resources.AWS::CloudWatch::Alarm.Properties.EvaluationPeriods,10
Resources.AWS::CloudWatch::Alarm.Type,AWS::CloudWatch::Alarm
Outputs.CriticalAlarmArn.Value,CriticalAlarm.Arn
Resources.AWS::CloudWatch::Alarm.Properties.MetricName,PermittedThroughput
Resources.AWS::AutoScaling::LaunchConfiguration.Properties.InstanceMonitoring,True
Resources.AWS::AutoScaling::LaunchConfiguration.Properties.IamInstanceProfile,InstanceProfile
Parameters.WarningThreshold.Default,180
Resources.AWS::CloudWatch::Alarm.Properties.AlarmActions,"[u'SNSTopic', u'AutoScalingPolicy']"
Resources.AWS::CloudWatch::Alarm.Properties.Namespace,AWS/EFS
Resources.AWS::AutoScaling::AutoScalingGroup.CreationPolicy.ResourceSignal.Timeout,PT5M
Parameters.Subnet.Type,List<AWS::EC2::Subnet::Id>
Parameters.SecurityGroup.Type,AWS::EC2::SecurityGroup::Id
Resources.AWS::AutoScaling::ScalingPolicy.Properties.AutoScalingGroupName,AutoScalingGroup
Resources.AWS::AutoScaling::LaunchConfiguration.Properties.BlockDeviceMappings,"[{u'DeviceName': u'/dev/xvda', u'Ebs': {u'DeleteOnTermination': True, u'VolumeType': u'gp2', u'VolumeSize': 10}}]"
Resources.AWS::CloudWatch::Alarm.Properties.Period,60
Outputs.BurstCreditBalanceIncreaseAlarmArn.Value,BurstCreditBalanceIncreaseAlarm.Arn
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.HealthCheckGracePeriod,120
Outputs.WarningAlarmArn.Value,WarningAlarm.Arn
Resources.AWS::AutoScaling::ScalingPolicy.Properties.PolicyType,SimpleScaling
Resources.AWS::IAM::Role.Properties.Policies,"[{u'PolicyName': u'efs-burst-credit-balance-cloudwatch-alarms', u'PolicyDocument': {u'Version': u'2012-10-17', u'Statement': [{u'Action': [u'cloudwatch:GetMetricStatistics', u'cloudwatch:PutMetricAlarm', u'autoscaling:DescribeAutoScalingGroups', u'autoscaling:DescribeAutoScalingInstances', u'autoscaling:DescribePolicies', u'autoscaling:UpdateAutoScalingGroup', u'elasticfilesystem:DescribeFileSystems'], u'Resource': u'*', u'Effect': u'Allow'}, {u'Action': [u'sns:Publish'], u'Resource': u'SNSTopic', u'Effect': u'Allow'}]}}]"
Mappings.RegionMap.ca-central-1.AMI,ami-fd55ec99
Resources.AWS::AutoScaling::LaunchConfiguration.Properties.KeyName,EC2KeyName
Resources.AWS::AutoScaling::AutoScalingGroup.CreationPolicy.ResourceSignal.Count,0
Parameters.NumberOfSubnets.AllowedValues,"[2, 3, 4, 5, 6]"
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.LaunchConfigurationName,LaunchConfiguration
Resources.AWS::AutoScaling::ScalingPolicy.Properties.AdjustmentType,ChangeInCapacity
Resources.AWS::CloudWatch::Alarm.Properties.Statistic,Sum
Resources.AWS::AutoScaling::ScalingPolicy.Properties.Cooldown,60
Metadata.AWS::CloudFormation::Interface.ParameterLabels.SecurityGroup.default,EFS Security Group
Parameters.NumberOfSubnets.Default,3
Metadata.AWS::CloudFormation::Interface.ParameterLabels.ElasticFileSystem.default,Amazon EFS File System
Parameters.CriticalThreshold.AllowedPattern,^[0-9]+$
Metadata.AWS::CloudFormation::Interface.ParameterLabels.EC2KeyName.default,Existing Key Pair
Parameters.EC2KeyName.Description,Name of an existing EC2 key pair
Resources.AWS::AutoScaling::LaunchConfiguration.Metadata.AWS::CloudFormation::Init.configSets.set_cloudwatch_alarms,[u'set-cloudwatch-alarms']
Resources.AWS::IAM::Role.Properties.AssumeRolePolicyDocument.Statement,"[{u'Action': [u'sts:AssumeRole'], u'Effect': u'Allow', u'Principal': {u'Service': [u'ec2.amazonaws.com']}}]"
Metadata.Authors.Description,Darryl Osborne (darrylo@amazon.com)
Parameters.NumberOfSubnets.Type,String
Resources.AWS::CloudWatch::Alarm.DependsOn,BurstCreditBalanceDecreaseAlarm
Metadata.AWS::CloudFormation::Interface.ParameterLabels.CriticalThreshold.default,Burst Credit Balance Critical Threshold (Minutes)
Resources.AWS::AutoScaling::ScalingPolicy.Type,AWS::AutoScaling::ScalingPolicy
Parameters.EmailAddress.Description,The email address for SNS notifications.
Resources.AWS::CloudWatch::Alarm.Properties.Dimensions,"[{u'Name': u'FileSystemId', u'Value': u'ElasticFileSystem'}]"
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.Cooldown,60
Parameters.CriticalThreshold.ConstraintDescription,Must be an integer.
Parameters.SecurityGroup.Description,Select the Amazon EFS security group.
Resources.AWS::AutoScaling::LaunchConfiguration.Type,AWS::AutoScaling::LaunchConfiguration
Parameters.NumberOfSubnets.Description,Number of subnets. This must match your selections in the list of Subnets below.
Resources.AWS::AutoScaling::AutoScalingGroup.Type,AWS::AutoScaling::AutoScalingGroup
Resources.AWS::AutoScaling::LaunchConfiguration.Properties.ImageId,"[u'RegionMap', u'AWS::Region', u'AMI']"
Resources.AWS::AutoScaling::LaunchConfiguration.Metadata.AWS::CloudFormation::Init.set-cloudwatch-alarms.files./tmp/set-cloudwatch-alarms.sh.group,root
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.MaxSize,1
Resources.AWS::IAM::Role.Properties.Path,/
Resources.AWS::SNS::Topic.Type,AWS::SNS::Topic
Resources.AWS::IAM::Role.Type,AWS::IAM::Role
Resources.AWS::AutoScaling::LaunchConfiguration.Metadata.AWS::CloudFormation::Init.set-cloudwatch-alarms.files./tmp/set-cloudwatch-alarms.sh.content,"[u'', [u'#!/bin/bash -x\n', u'\n', u'FILE_SYSTEM_ID=$1\n', u'WARNING_THRESHOLD_MINUTES=$2\n', u'CRITICAL_THRESHOLD_MINUTES=$3\n', u'SNS_ARN=$4\n', u'\n', u'error=0\n', u'\n', u'# get region\n', u'availability_zone=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)\n', u'region=${availability_zone:0:-1}\n', u'\n', u'# get instance id\n', u'instance_id=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)\n', u'\n', u'# get autoscaling group name\n', u""asg_name=$(aws autoscaling describe-auto-scaling-instances --instance-ids ${instance_id} --region ${region} --output text --query 'AutoScalingInstances[0].AutoScalingGroupName')\n"", u'\n', u'# get autoscaling policy arn\n', u""asg_policy_arn=$(aws autoscaling describe-policies --auto-scaling-group-name ${asg_name} --region ${region} --output text --query 'ScalingPolicies[0].PolicyARN')\n"", u'\n', u""# validate FILE_SYSTEM_ID send notification and exit if doesn't exist\n"", u""aws efs describe-file-systems --file-system-id ${FILE_SYSTEM_ID} --region ${region} --output text --query 'FileSystems[0].[FileSystemId]'\n"", u'result=$?\n', u'if [ $result -ne 0 ]; then\n', u""   aws sns publish --topic-arn ${SNS_ARN} --region ${region} --message 'Amazon EFS burst credit balance CloudWatch alarm error. File system '${FILE_SYSTEM_ID}' does not exist.'\n"", u'   exit\n', u'fi\n', u'\n', u'# get current permitted throughput\n', u'count=1\n', u'while [ -z ${permitted_throughput} ] || [ ${permitted_throughput} == null ] && [ ${count} -lt 60 ]; do\n', u""   permitted_throughput=$(aws cloudwatch get-metric-statistics --namespace AWS/EFS --metric-name PermittedThroughput --dimensions Name=FileSystemId,Value=${FILE_SYSTEM_ID} --start-time $(date --utc +%FT%TZ -d '-120 seconds') --end-time $(date --utc +%FT%TZ -d '-60 seconds') --period 60 --statistics Sum --region ${region} --output json --query 'Datapoints[0].Sum')\n"", u'   sleep 2\n', u'   count=$(expr ${count} + 1)\n', u'done\n', u'\n', u'# get current burst credit balance\n', u'count=1\n', u'while [ -z ${burst_credit_balance} ] || [ ${burst_credit_balance} == null ] && [ ${count} -lt 60 ]; do\n', u""   burst_credit_balance=$(aws cloudwatch get-metric-statistics --namespace AWS/EFS --metric-name BurstCreditBalance --dimensions Name=FileSystemId,Value=${FILE_SYSTEM_ID} --start-time $(date --utc +%FT%TZ -d '-120 seconds') --end-time $(date --utc +%FT%TZ -d '-60 seconds') --period 60 --statistics Sum --region ${region} --output json --query 'Datapoints[0].Sum')\n"", u'   sleep 2\n', u'   count=$(expr ${count} + 1)\n', u'done\n', u'\n', u'# calculate new burst credit balance warning threshold\n', u'burst_credit_balance_threshold_warning=$(( ${burst_credit_balance:0:-2} - ( ( ( ${burst_credit_balance:0:-2} / ( ${permitted_throughput:0:-2} * 60 ) ) - $WARNING_THRESHOLD_MINUTES ) * ( ${permitted_throughput:0:-2} * 60 ) ) ))\n', u'\n', u'# calculate new burst credit balance critical threshold\n', u'burst_credit_balance_threshold_critical=$(( ${burst_credit_balance:0:-2} - ( ( ( ${burst_credit_balance:0:-2} / ( ${permitted_throughput:0:-2} * 60 ) ) - $CRITICAL_THRESHOLD_MINUTES ) * ( ${permitted_throughput:0:-2} * 60 ) ) ))\n', u'\n', u'# update warning alarm with new burst credit balance warning threshold\n', u""aws cloudwatch put-metric-alarm --alarm-name ''${FILE_SYSTEM_ID}' burst credit balance - Warning - '"", u'AWS::StackName', u"" --alarm-description ''${FILE_SYSTEM_ID}' burst credit balance - Warning - '"", u'AWS::StackName', u' --actions-enabled --alarm-actions ${SNS_ARN} --metric-name BurstCreditBalance --namespace AWS/EFS --statistic Sum --dimensions Name=FileSystemId,Value=${FILE_SYSTEM_ID} --period 60 --evaluation-periods 5 --threshold ${burst_credit_balance_threshold_warning} --comparison-operator LessThanThreshold --treat-missing-data missing --region ${region}\n', u'result=$?\n', u'if [ $result -ne 0 ]; then\n', u""   aws sns publish --topic-arn ${SNS_ARN} --region ${region} --message 'Amazon EFS burst credit balance CloudWatch alarm error. Check CloudWatch alarms for file system '${FILE_SYSTEM_ID}'.'\n"", u'   error=$(expr ${error} + 1)\n', u'fi\n', u'\n', u'# update critical alarm with new burst credit balance critical threshold\n', u""aws cloudwatch put-metric-alarm --alarm-name ''${FILE_SYSTEM_ID}' burst credit balance - Critical - '"", u'AWS::StackName', u"" --alarm-description ''${FILE_SYSTEM_ID}' burst credit balance - Critical - '"", u'AWS::StackName', u' --actions-enabled --alarm-actions ${SNS_ARN} --metric-name BurstCreditBalance --namespace AWS/EFS --statistic Sum --dimensions Name=FileSystemId,Value=${FILE_SYSTEM_ID} --period 60 --evaluation-periods 5 --threshold ${burst_credit_balance_threshold_critical} --comparison-operator LessThanThreshold --treat-missing-data missing --region ${region}\n', u'result=$?\n', u'if [ $result -ne 0 ]; then\n', u""   aws sns publish --topic-arn ${SNS_ARN} --region ${region} --message 'Amazon EFS burst credit balance CloudWatch alarm error. Check CloudWatch alarms for file system '${FILE_SYSTEM_ID}'.'\n"", u'   error=$(expr ${error} + 1)\n', u'fi\n', u'\n', u'# update burst credit balance increase threshold based\n', u""aws cloudwatch put-metric-alarm --alarm-name 'Set '${FILE_SYSTEM_ID}' burst credit balance increase threshold - '"", u'AWS::StackName', u"" --alarm-description 'Set '${FILE_SYSTEM_ID}' burst credit balance increase threshold - '"", u'AWS::StackName', u' --actions-enabled --alarm-actions ${SNS_ARN} ${asg_policy_arn} --metric-name PermittedThroughput --namespace AWS/EFS --statistic Sum --dimensions Name=FileSystemId,Value=${FILE_SYSTEM_ID} --period 60 --evaluation-periods 5 --threshold ${permitted_throughput:0:-2} --comparison-operator GreaterThanThreshold --treat-missing-data missing --region ${region}\n', u'result=$?\n', u'if [ $result -ne 0 ]; then\n', u""   aws sns publish --topic-arn ${SNS_ARN} --region ${region} --message 'Amazon EFS burst credit balance CloudWatch alarm error. Check CloudWatch alarms for file system '${FILE_SYSTEM_ID}'.'\n"", u'   error=$(expr ${error} + 1)\n', u'fi\n', u'\n', u'# update burst credit balance decrease threshold based\n', u""aws cloudwatch put-metric-alarm --alarm-name 'Set '${FILE_SYSTEM_ID}' burst credit balance decrease threshold - '"", u'AWS::StackName', u"" --alarm-description 'Set '${FILE_SYSTEM_ID}' burst credit balance decrease threshold - '"", u'AWS::StackName', u' --actions-enabled --alarm-actions ${SNS_ARN} ${asg_policy_arn} --metric-name PermittedThroughput --namespace AWS/EFS --statistic Sum --dimensions Name=FileSystemId,Value=${FILE_SYSTEM_ID} --period 60 --evaluation-periods 5 --threshold ${permitted_throughput:0:-2} --comparison-operator LessThanThreshold --treat-missing-data missing --region ${region}\n', u'result=$?\n', u'if [ $result -ne 0 ]; then\n', u""   aws sns publish --topic-arn ${SNS_ARN} --region ${region} --message 'Amazon EFS burst credit balance CloudWatch alarm error. Check CloudWatch alarms for file system '${FILE_SYSTEM_ID}'.'\n"", u'   error=$(expr ${error} + 1)\n', u'fi\n', u'\n', u'# auto terminate instance - setting auto scaling group desired capacity 0\n', u'if [ $error -eq 0 ]; then\n', u'   aws autoscaling update-auto-scaling-group --auto-scaling-group-name ${asg_name} --desired-capacity 0 --region ${region}\n', u'   else\n', u""   aws sns publish --topic-arn ${SNS_ARN} --region ${region} --message 'Amazon EFS burst credit balance CloudWatch alarm error. Check CloudWatch alarms for file system '${FILE_SYSTEM_ID}'.'\n"", u'fi\n', u'\n']]"
Resources.AWS::AutoScaling::AutoScalingGroup.Properties.VPCZoneIdentifier,"[u'NumberOfSubnets1', [[0, u'Subnet']], [u'NumberOfSubnets2', [[0, u'Subnet'], [1, u'Subnet']], [u'NumberOfSubnets3', [[0, u'Subnet'], [1, u'Subnet'], [2, u'Subnet']], [u'NumberOfSubnets4', [[0, u'Subnet'], [1, u'Subnet'], [2, u'Subnet'], [3, u'Subnet']], [u'NumberOfSubnets5', [[0, u'Subnet'], [1, u'Subnet'], [2, u'Subnet'], [3, u'Subnet'], [4, u'Subnet']], [[0, u'Subnet'], [1, u'Subnet'], [2, u'Subnet'], [3, u'Subnet'], [4, u'Subnet'], [5, u'Subnet']]]]]]]"
Parameters.CriticalThreshold.Description,Send critical alarm this minutes before burst credit balance is zero.
Resources.AWS::CloudWatch::Alarm.Properties.Threshold,0
Parameters.WarningThreshold.AllowedPattern,^[0-9]+$
Resources.AWS::IAM::InstanceProfile.Type,AWS::IAM::InstanceProfile
Resources.AWS::AutoScaling::LaunchConfiguration.Metadata.AWS::CloudFormation::Init.set-cloudwatch-alarms.files./tmp/set-cloudwatch-alarms.sh.mode,511
Parameters.CriticalThreshold.Type,String
Resources.AWS::AutoScaling::ScalingPolicy.Properties.ScalingAdjustment,1
Resources.AWS::SNS::Topic.Properties.DisplayName,"[u'', [u'ElasticFileSystem', u'-alarm-notification']]"
Resources.AWS::SNS::Topic.Properties.Subscription,"[{u'Endpoint': u'EmailAddress', u'Protocol': u'email'}]"
Parameters.WarningThreshold.ConstraintDescription,Must be an integer.
Parameters.ElasticFileSystem.Description,The Amazon EFS file system id.
Resources.AWS::IAM::InstanceProfile.Properties.Roles,[u'InstanceRole']
